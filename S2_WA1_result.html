<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book 2 ç­çº§æˆç»©åˆ†ææŠ¥å‘Š (AI å¢å¼ºç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <!-- Add Markdown parser for nice AI output -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #F3F4F6; 
        }

        /* Chart Container Styles */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 100%; 
            margin-left: auto;
            margin-right: auto;
            height: 350px; 
            max-height: 400px;
        }

        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }

        /* Markdown Styles for AI Output */
        .prose h3 { font-size: 1.25rem; font-weight: 700; margin-top: 1rem; margin-bottom: 0.5rem; color: #4F46E5; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
        .prose li { margin-bottom: 0.25rem; }
        .prose strong { color: #111827; font-weight: 600; }
        .prose p { margin-bottom: 0.75rem; line-height: 1.6; }
        
        /* Loading Animation */
        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: #4F46E5;
            border-radius: 50%;
            animation: typing 1s infinite;
            margin: 0 2px;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 100% { transform: translateY(0); opacity: 0.5; }
            50% { transform: translateY(-5px); opacity: 1; }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header Section -->
    <header class="bg-gradient-to-r from-indigo-700 to-cyan-600 text-white shadow-lg">
        <div class="container mx-auto px-6 py-10">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <div>
                    <h1 class="text-4xl md:text-5xl font-bold mb-4">Book 2 æµ‹éªŒæˆç»©åˆ†æ</h1>
                    <p class="text-xl opacity-90 max-w-2xl">
                        åŸºäº 36 åå­¦ç”Ÿçš„å®æµ‹æ•°æ®ï¼ˆæ»¡åˆ† 40 åˆ†ï¼‰ã€‚å« âœ¨ AI æ™ºèƒ½åŠ©æ•™åˆ†æåŠŸèƒ½ã€‚
                    </p>
                </div>
                <div class="bg-white/10 backdrop-blur-md p-4 rounded-lg border border-white/20">
                    <p class="text-xs uppercase tracking-wider opacity-75 mb-1">AI Status</p>
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></span>
                        <span class="font-bold">Gemini Online</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Grid -->
    <main class="container mx-auto px-4 py-8 space-y-8">

        <!-- AI Assistant Section (NEW) -->
        <section class="bg-gradient-to-br from-indigo-50 to-white rounded-xl shadow-lg border-2 border-indigo-100 overflow-hidden relative">
            <div class="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
                <svg width="120" height="120" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>
            </div>
            
            <div class="p-6 md:p-8">
                <h2 class="text-2xl font-bold text-indigo-800 flex items-center gap-2 mb-4">
                    <span>âœ¨</span> AI æ™ºèƒ½åŠ©æ•™ (AI Teaching Assistant)
                </h2>
                <p class="text-gray-600 mb-6 max-w-3xl">
                    åˆ©ç”¨ Gemini å¤§æ¨¡å‹å¯¹ç­çº§æˆç»©è¿›è¡Œæ·±åº¦è¯Šæ–­ã€‚AI å¯ä»¥åˆ†ææ•°æ®æ¨¡å¼ï¼Œæä¾›æ•™å­¦å»ºè®®ï¼Œç”šè‡³å›ç­”å…³äºç‰¹å®šå­¦ç”Ÿçš„å…·ä½“é—®é¢˜ã€‚
                </p>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Action: Generate Report -->
                    <div class="md:col-span-1 space-y-4">
                        <button onclick="generateAIReport()" id="btn-report" class="w-full group relative bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-4 px-6 rounded-xl shadow-md transition-all duration-300 flex items-center justify-center gap-3 overflow-hidden">
                            <span class="absolute inset-0 w-full h-full bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover:animate-[shimmer_1.5s_infinite]"></span>
                            <span class="text-xl">ğŸ“Š</span>
                            <span>ç”Ÿæˆç­çº§è¯Šæ–­æŠ¥å‘Š</span>
                        </button>
                        
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ’¬ è¯¢é—®æ•°æ® (Ask Data)</label>
                            <div class="flex gap-2">
                                <input type="text" id="ai-query" placeholder="ä¾‹ï¼šå“ªäº›å­¦ç”Ÿéœ€è¦è¡¥è¯¾ï¼Ÿ" class="flex-1 border-gray-300 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                                <button onclick="askAI()" id="btn-ask" class="bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg px-3 py-2 transition-colors">
                                    â¤
                                </button>
                            </div>
                            <div class="mt-2 flex flex-wrap gap-2 text-xs text-gray-500">
                                <span class="cursor-pointer hover:text-indigo-600 bg-gray-100 px-2 py-1 rounded" onclick="setInput('æœ€é«˜åˆ†æ˜¯è°ï¼Ÿ')">æœ€é«˜åˆ†æ˜¯è°ï¼Ÿ</span>
                                <span class="cursor-pointer hover:text-indigo-600 bg-gray-100 px-2 py-1 rounded" onclick="setInput('å¦‚ä½•æé«˜å¹³å‡åˆ†ï¼Ÿ')">å»ºè®®</span>
                                <span class="cursor-pointer hover:text-indigo-600 bg-gray-100 px-2 py-1 rounded" onclick="setInput('åˆ†ææˆç»©åˆ†å¸ƒ')">åˆ†å¸ƒåˆ†æ</span>
                            </div>
                        </div>
                    </div>

                    <!-- Output Area -->
                    <div class="md:col-span-2 bg-white rounded-xl border border-gray-200 min-h-[250px] p-6 shadow-inner relative">
                        <div id="ai-loading" class="hidden absolute inset-0 bg-white/80 flex items-center justify-center z-10 backdrop-blur-sm rounded-xl">
                            <div class="text-center">
                                <div class="typing-indicator text-3xl mb-2"><span></span><span></span><span></span></div>
                                <p class="text-indigo-600 font-medium text-sm animate-pulse">Gemini æ­£åœ¨åˆ†ææ•°æ®...</p>
                            </div>
                        </div>
                        <div id="ai-content" class="prose prose-sm max-w-none text-gray-700">
                            <div class="flex flex-col items-center justify-center h-full text-gray-400 py-10">
                                <svg class="w-12 h-12 mb-3 opacity-20" fill="currentColor" viewBox="0 0 24 24"><path d="M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1zm-4 6V3c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v14l4-4h10c.55 0 1-.45 1-1z"/></svg>
                                <p>ç‚¹å‡»å·¦ä¾§æŒ‰é’®ç”ŸæˆæŠ¥å‘Šï¼Œæˆ–è¾“å…¥é—®é¢˜ã€‚</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 1: Introduction & KPIs -->
        <section>
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-indigo-700 border-l-4 border-rose-500 pl-3">æ ¸å¿ƒæŒ‡æ ‡æ¦‚è§ˆ (KPIs)</h2>
                <p class="mt-2 text-gray-600">
                    æ€»ä½“æ¥çœ‹ï¼Œç­çº§å¹³å‡åˆ†ä¸º 21.3 åˆ†ï¼ˆç™¾åˆ†åˆ¶çº¦ä¸º 53%ï¼‰ï¼Œæ˜¾ç¤ºè¯•å·å…·æœ‰ä¸€å®šéš¾åº¦æˆ–å­¦ç”Ÿæ•´ä½“æŒæ¡ç¨‹åº¦ä¸€èˆ¬ã€‚
                </p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- KPI Card 1 -->
                <div class="bg-white rounded-xl shadow-md p-6 border-t-4 border-indigo-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500 uppercase">å¹³å‡åˆ† (Avg Score)</p>
                            <p class="text-4xl font-bold text-indigo-700 mt-2">21.3 <span class="text-base text-gray-400 font-normal">/ 40</span></p>
                        </div>
                        <div class="text-3xl">ğŸ“Š</div>
                    </div>
                    <p class="text-sm text-gray-500 mt-4">ä¸­ä½æ•°: 20.0 åˆ†</p>
                </div>

                <!-- KPI Card 2 -->
                <div class="bg-white rounded-xl shadow-md p-6 border-t-4 border-cyan-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500 uppercase">åŠæ ¼ç‡ (Pass Rate)</p>
                            <p class="text-4xl font-bold text-cyan-600 mt-2">77.8%</p>
                        </div>
                        <div class="text-3xl">ğŸ“</div>
                    </div>
                    <p class="text-sm text-gray-500 mt-4">åŸºå‡†: >16åˆ† (40%)</p>
                </div>

                <!-- KPI Card 3 -->
                <div class="bg-white rounded-xl shadow-md p-6 border-t-4 border-rose-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500 uppercase">æœ€é«˜åˆ† (Highest)</p>
                            <p class="text-4xl font-bold text-rose-500 mt-2">40</p>
                        </div>
                        <div class="text-3xl">ğŸ†</div>
                    </div>
                    <p class="text-sm text-rose-600 mt-4 font-semibold">å­¦å·: #32 (æ»¡åˆ†)</p>
                </div>
            </div>
        </section>

        <!-- Section 2: Score Distribution (Histogram) -->
        <section class="bg-white rounded-xl shadow-md p-6">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-indigo-700 border-l-4 border-cyan-500 pl-3">åˆ†æ•°æ®µåˆ†å¸ƒç›´æ–¹å›¾</h2>
                <p class="mt-2 text-gray-600">
                    å°†æˆç»©æŒ‰åŒºé—´åˆ’åˆ†ï¼Œå¯ä»¥æ˜æ˜¾çœ‹å‡º**16-20åˆ†**åŠ**21-25åˆ†**æ˜¯äººæ•°æœ€é›†ä¸­çš„åŒºåŸŸï¼Œå‘ˆç°å‡ºæ­£æ€åˆ†å¸ƒçš„ç‰¹å¾ï¼Œä½†å·¦ä¾§é•¿å°¾ï¼ˆä½åˆ†æ®µï¼‰è¾ƒå¤šã€‚
                </p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <div class="chart-container">
                        <canvas id="histogramChart"></canvas>
                    </div>
                </div>
                <div class="bg-indigo-50 rounded-lg p-5 flex flex-col justify-center">
                    <h3 class="font-bold text-lg text-indigo-800 mb-3">åˆ†å¸ƒæ´å¯Ÿ</h3>
                    <ul class="space-y-3">
                        <li class="flex items-start">
                            <span class="text-cyan-600 mr-2">â—</span>
                            <span class="text-sm text-gray-700"><strong>ä¼—æ•°åŒºé—´</strong>ï¼š16-20åˆ† å’Œ 21-25åˆ†ï¼Œå„æœ‰ 9 äººå’Œ 8 äººï¼Œå æ®äº†ç­çº§è¿‘åŠæ•°ã€‚</span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-indigo-600 mr-2">â—</span>
                            <span class="text-sm text-gray-700"><strong>é«˜åˆ†ç¨€ç¼º</strong>ï¼š35åˆ†ä»¥ä¸Šçš„å­¦ç”Ÿä»…æœ‰ 1 äººï¼ˆ#32ï¼Œ40åˆ†ï¼‰ã€‚</span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-rose-500 mr-2">â—</span>
                            <span class="text-sm text-gray-700"><strong>ä½åˆ†é¢„è­¦</strong>ï¼š10-15åˆ†åŒºé—´æœ‰ 6 äººï¼ŒåŠ ä¸Š 2 åç¼ºå‹¤/æ— æˆç»©è€…ï¼Œå…±æœ‰ 8 äººå±äºé«˜é£é™©ç¾¤ä½“ã€‚</span>
                        </li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Section 3: Grade Composition & Student Roll Call -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-8">
            
            <!-- Grade Composition -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-xl font-bold text-indigo-700 mb-2">ç­‰çº§æ¯”ä¾‹æ„æˆ</h3>
                <p class="text-sm text-gray-600 mb-4">
                    æŒ‰æ ‡å‡†åˆ’åˆ†ï¼šA(â‰¥32), B(24-31), C(16-23), D(10-15), F(<10/Absent)ã€‚
                </p>
                <div class="chart-container">
                    <canvas id="gradeDoughnutChart"></canvas>
                </div>
            </div>

            <!-- Student Line Chart -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-xl font-bold text-indigo-700 mb-2">å­¦å·-æˆç»© èµ°åŠ¿å›¾</h3>
                <p class="text-sm text-gray-600 mb-4">
                    æŒ‰å­¦å·é¡ºåºæ’åˆ—çš„æˆç»©æ³¢åŠ¨ã€‚æ³¨æ„å­¦å· 21ã€22 çš„æ–­å±‚ï¼ˆç¼ºå‹¤/æ— æ•°æ®ï¼‰ä»¥åŠ 32 å·çš„å³°å€¼ã€‚
                </p>
                <div class="chart-container">
                    <canvas id="scoreLineChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Section 4: Deep Dive - Plotly (Scatter) -->
        <section class="bg-white rounded-xl shadow-md p-6">
            <div class="mb-4">
                <h2 class="text-2xl font-bold text-indigo-700 border-l-4 border-rose-500 pl-3">å­¦ç”Ÿä¸ªä½“è¡¨ç°å®šä½å›¾</h2>
                <p class="mt-2 text-gray-600">
                    æ­¤æ•£ç‚¹å›¾å±•ç¤ºäº†æ¯ä½å­¦ç”Ÿçš„å…·ä½“å¾—åˆ†ã€‚
                    <span class="text-green-600 font-bold">ç»¿è‰²åŒºåŸŸ</span>ä»£è¡¨ä¼˜ç§€ï¼Œ
                    <span class="text-yellow-600 font-bold">é»„è‰²åŒºåŸŸ</span>ä»£è¡¨åˆæ ¼ï¼Œ
                    <span class="text-red-500 font-bold">çº¢è‰²åŒºåŸŸ</span>ä»£è¡¨éœ€è¦å¹²é¢„ã€‚
                </p>
            </div>
            <!-- Plotly Container -->
            <div id="scatterPlot" class="w-full h-[450px] border border-gray-100 rounded-lg"></div>
            <div class="mt-4 p-4 bg-gray-50 rounded-lg border-l-4 border-indigo-500">
                <p class="text-sm text-gray-800">
                    <strong>é‡ç‚¹å…³æ³¨åå•ï¼š</strong> å­¦å· #12 (11åˆ†), #29 (11åˆ†), #17 (13åˆ†), #24 (13åˆ†), #26 (14åˆ†), #27 (15åˆ†)ã€‚
                    <br>ç¼ºå‹¤/æ— æˆç»©ï¼š#21, #22ã€‚
                </p>
            </div>
        </section>

        <!-- Footer -->
        <footer class="text-center text-gray-500 text-sm py-8 border-t border-gray-200 mt-8">
            <p>&copy; 2026 æ•™å­¦è¯„ä¼°ç³»ç»Ÿ | Data Source: Book 2.pdf | Powered by Google Gemini</p>
        </footer>

    </main>

    <!-- JavaScript Logic -->
    <script>
        // --- 0. AI CONFIGURATION & UTILS ---
        const apiKey = ""; // System provides this automatically
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // Raw Data for AI Context
        const rawScores = [
            27, 17, 18, 25, 16, 20, 34, 25, 19, 26, 
            27, 11, 28, 22, 20, 24, 13, 20, 17, 33, 
            null, null, // 21, 22 (Absent)
            27, 13, 20, 14, 15, 26, 11, 19, 
            21, 40, 20, 18, 17, 21
        ];

        // Prepare context string for AI
        const dataContext = `
        Class Size: 36 students.
        Max Possible Score: 40.
        Pass Score: 16 (40%).
        Scores (by Index 1-36): ${rawScores.map((s, i) => `ID${i+1}:${s === null ? 'Absent' : s}`).join(', ')}.
        Key Stats: Avg 21.3, Median 20.0, Max 40 (ID 32), Failures/Absent approx 8.
        `;

        function setInput(text) {
            document.getElementById('ai-query').value = text;
        }

        async function callGemini(prompt) {
            const loading = document.getElementById('ai-loading');
            const contentDiv = document.getElementById('ai-content');
            
            loading.classList.remove('hidden');
            contentDiv.classList.add('opacity-50');

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: `Context: ${dataContext}\n\nTask: ${prompt}\n\nPlease format the response using Markdown. Keep it professional, encouraging, and concise.` }]
                        }]
                    })
                });

                if (!response.ok) throw new Error('API request failed');

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                
                // Parse Markdown and display
                contentDiv.innerHTML = marked.parse(text);
            } catch (error) {
                console.error(error);
                contentDiv.innerHTML = `<p class="text-red-500">âŒ AI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•ã€‚<br><small>${error.message}</small></p>`;
            } finally {
                loading.classList.add('hidden');
                contentDiv.classList.remove('opacity-50');
            }
        }

        function generateAIReport() {
            const prompt = "ä½œä¸ºä¸€åèµ„æ·±æ•™è‚²æ•°æ®åˆ†æå¸ˆï¼Œè¯·ç”¨ä¸­æ–‡ä¸ºè¿™åæ•™å¸ˆç”Ÿæˆä¸€ä»½ç­çº§æˆç»©è¯Šæ–­æŠ¥å‘Šã€‚åŒ…å«ï¼š1. æ•´ä½“å­¦æƒ…æ€»ç»“ï¼ˆè¯­æ°”ä¸“ä¸šï¼‰ã€‚2. å€¼å¾—è¡¨æ‰¬çš„é«˜åˆ†å­¦ç”Ÿåˆ†æã€‚3. éœ€è¦å…³æ³¨çš„ä½åˆ†/ç¼ºå‹¤å­¦ç”Ÿç¾¤ä½“åˆ†æã€‚4. é’ˆå¯¹æ€§çš„æ•™å­¦æ”¹è¿›å»ºè®®ï¼ˆåˆ—å‡º3ç‚¹ï¼‰ã€‚è¯·ä½¿ç”¨ Markdown æ ¼å¼ï¼ŒåŒ…å« Emoji å›¾æ ‡ã€‚";
            callGemini(prompt);
        }

        function askAI() {
            const query = document.getElementById('ai-query').value;
            if (!query) return;
            const prompt = `ç”¨æˆ·æé—®ï¼š${query}\n\nè¯·ç”¨ä¸­æ–‡å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚å¦‚æœé—®é¢˜æ¶‰åŠå…·ä½“å­¦ç”Ÿï¼Œè¯·åˆ—å‡ºä»–ä»¬çš„å­¦å·ã€‚åŸºäºæä¾›çš„æ•°æ®è¿›è¡Œå›ç­”ï¼Œä¸è¦ç¼–é€ æ•°æ®ã€‚`;
            callGemini(prompt);
        }


        // --- 1. EXISTING CHART DATA PROCESSING ---
        const labels = Array.from({length: 36}, (_, i) => (i + 1).toString());

        // Calculate Histogram Bins
        const bins = [0, 0, 0, 0, 0, 0];
        const binLabels = ["10-15 (éœ€åŠªåŠ›)", "16-20 (åˆæ ¼)", "21-25 (ä¸­ç­‰)", "26-30 (è‰¯å¥½)", "31-35 (ä¼˜ç§€)", "36-40 (å“è¶Š)"];
        
        let validCount = 0;
        let sum = 0;
        let gradeCounts = { A:0, B:0, C:0, D:0, F:0 }; // A: >=32, B: 24-31, C: 16-23, D: 10-15, F: Absent/Fail

        rawScores.forEach(score => {
            if (score === null) {
                gradeCounts.F++;
                return;
            }
            validCount++;
            sum += score;

            // Histogram Bins
            if (score <= 15) bins[0]++;
            else if (score <= 20) bins[1]++;
            else if (score <= 25) bins[2]++;
            else if (score <= 30) bins[3]++;
            else if (score <= 35) bins[4]++;
            else bins[5]++;

            // Grade Classification
            if (score >= 32) gradeCounts.A++;
            else if (score >= 24) gradeCounts.B++;
            else if (score >= 16) gradeCounts.C++;
            else gradeCounts.D++; // 10-15
        });

        // --- 2. CHART CONFIG ---
        const colors = {
            primary: '#4F46E5',   // Indigo
            secondary: '#06B6D4', // Cyan
            accent: '#F43F5E',    // Rose
            warning: '#F59E0B',   // Amber
            gray: '#9CA3AF'
        };

        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    backgroundColor: 'rgba(17, 24, 39, 0.9)',
                    padding: 12,
                    cornerRadius: 8,
                    callbacks: {
                        title: function(tooltipItems) {
                            return tooltipItems[0].label;
                        }
                    }
                }
            }
        };

        // --- 3. CHART INSTANCES ---

        // Chart 1: Histogram (Bar)
        new Chart(document.getElementById('histogramChart'), {
            type: 'bar',
            data: {
                labels: binLabels,
                datasets: [{
                    label: 'å­¦ç”Ÿäººæ•°',
                    data: bins,
                    backgroundColor: [
                        colors.accent, // 10-15 Red
                        colors.secondary, // 16-20 Cyan
                        colors.primary, // 21-25 Indigo
                        '#3B82F6', // 26-30 Blue
                        '#10B981', // 31-35 Emerald
                        '#FCD34D'  // 36-40 Gold
                    ],
                    borderRadius: 6
                }]
            },
            options: {
                ...commonOptions,
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'äººæ•°' } }
                }
            }
        });

        // Chart 2: Grade Composition (Doughnut)
        new Chart(document.getElementById('gradeDoughnutChart'), {
            type: 'doughnut',
            data: {
                labels: ['A (ä¼˜ç§€ â‰¥32)', 'B (è‰¯å¥½ 24-31)', 'C (åˆæ ¼ 16-23)', 'D (éœ€åŠªåŠ› 10-15)', 'ç¼ºå‹¤/æ— æˆç»©'],
                datasets: [{
                    data: [gradeCounts.A, gradeCounts.B, gradeCounts.C, gradeCounts.D, gradeCounts.F],
                    backgroundColor: [
                        '#10B981', // Emerald A
                        '#3B82F6', // Blue B
                        colors.secondary, // Cyan C
                        colors.accent, // Rose D
                        colors.gray    // Gray F
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                ...commonOptions,
                cutout: '65%',
                plugins: { ...commonOptions.plugins, legend: { position: 'right' } }
            }
        });

        // Chart 3: Student Trend (Line)
        new Chart(document.getElementById('scoreLineChart'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'å­¦ç”Ÿåˆ†æ•°',
                    data: rawScores, 
                    borderColor: colors.primary,
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    borderWidth: 2,
                    pointBackgroundColor: colors.secondary,
                    pointRadius: 4,
                    tension: 0.2,
                    spanGaps: false 
                }]
            },
            options: {
                ...commonOptions,
                scales: {
                    y: { min: 0, max: 40, title: { display: true, text: 'åˆ†æ•°' } },
                    x: { title: { display: true, text: 'å­¦å· (Index)' } }
                }
            }
        });

        // Chart 4: Plotly Scatter (Deep Dive)
        const traceX = [];
        const traceY = [];
        const traceColor = [];
        const traceText = [];

        rawScores.forEach((score, index) => {
            let s = score === null ? 0 : score;
            let color = '#9CA3AF'; // Default gray for absent
            
            if (score !== null) {
                if (score >= 32) color = '#10B981'; // Green
                else if (score >= 16) color = '#FBBF24'; // Yellow/Amber
                else color = '#F43F5E'; // Red
            }

            traceX.push(index + 1);
            traceY.push(s);
            traceColor.push(color);
            traceText.push(`å­¦å· #${index + 1}: ${score === null ? 'ç¼ºå‹¤' : score + 'åˆ†'}`);
        });

        const plotData = [{
            x: traceX,
            y: traceY,
            mode: 'markers',
            type: 'scattergl',
            text: traceText,
            marker: { size: 12, color: traceColor, opacity: 0.8 }
        }];

        const plotLayout = {
            margin: { t: 20, r: 20, b: 40, l: 40 },
            hovermode: 'closest',
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            xaxis: { title: 'å­¦å·', gridcolor: '#E5E7EB' },
            yaxis: { title: 'åˆ†æ•°', gridcolor: '#E5E7EB', range: [0, 42] },
            shapes: [
                { // Pass Line
                    type: 'line', x0: 0, x1: 37, y0: 16, y1: 16,
                    line: { color: '#06B6D4', width: 1, dash: 'dash' }
                },
                { // Excellent Line
                    type: 'line', x0: 0, x1: 37, y0: 32, y1: 32,
                    line: { color: '#10B981', width: 1, dash: 'dash' }
                }
            ]
        };

        Plotly.newPlot('scatterPlot', plotData, plotLayout, {responsive: true, displayModeBar: false});

    </script>
</body>
</html>